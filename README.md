# Steganography-Based-on-IP-Packet
最近在做网络协议隐藏，在网上看到了一篇论文[基于IP包的信息隐藏技术](https://wenku.baidu.com/view/45ababdbce2f0066f53322a9.html)，原理是把要发送的信息隐藏到报文的IP字段中，来实现信息隐藏，感觉思路新颖，隐蔽性较高，于是浅析后用python进行了实现

## 分析
1. 如果改变报文中的目的IP，那么接收方将不能接收到报文，因此只能修改源IP
2. 修改源IP的同时还需要考虑到要伪造的源IP是否合法，不合法的报文网关将不能成功转发（此处需要考虑的一是IP的基本格式，二是伪造的IP是否在自己的网段内），即使能发送成功也会容易被攻击者发现（即：如果源地址和目的地址都不在自己网段内的报文为什么会出现在自己的局域网中？）
3. 接收方如何从大量报文中识别出隐藏信息的报文？接收方如何判断一段信息已经接收完毕？如果网络状况较差，接收方如何判断是否丢包以及报文中信息的排列顺序？

## 设计
### 发送方：
1. **采用UDP协议。** 原因有以下几点：
	1）TCP通信需要建立连接，不适合用于短暂的隐蔽通信
	2）在该方法中需要大量修改源IP，不适合使用TCP
2. **报文源IP的主机号段隐藏信息。** 由于在本实验中发送者局域网的主机号占了最后一字节，所以可隐藏信息的长度有一字节（实际情况根据子网长度来选择）。将要发送的信息的每个字节和目的IP地址的最后一字节异或，得到一组隐藏了信息的主机号，与真实源IP前缀组合成一组伪造源IP。保证了源IP合法的同时，将要发送的信息隐藏进了源IP
3. **设定源端口号范围为5000-5100，目的端口号为源端口号+10。**
	1）使用固定端口号的方法，让接收方能识别出是隐藏信息的UDP报文
	2）将端口号设定为一个范围，增加隐蔽性
	3）将源端口和目的端口建立某种算法联系，提高识别率
4. **MAC地址的最后一字节隐藏报文序号。** 为保证接收方可以判断接收到的报文序列，在报文中添加序号字段。将报文序号与当前报文的伪造主机号进行异或，用异或结果作为MAC地址的最后一字节（MAC地址其余字节随机生成），添加了序号字段的同时，伪造了MAC地址
5. **每次发送开始和结束时发送标志性报文。** 为了使接收方识别信息发送的开始和结束，每次发送开始和结束发送一个标志性报文，该报文的源IP地址由真实源IP的前缀+真实源IP的最后一字节和目的IP地址的最后一字节异或结果组成，报文的序号与整个发送过程连续。

### 接收方：
1. **筛选隐藏信息的目标报文。** 从大量数据报文中筛选出隐藏了信息的目的报文，筛选规则：
	1）目的地址为本机IP地址的UDP报文
	2）源端口为5000-5100，且目的端口为源端口+10
2. **计算当前报文序号和提取信息，构造本次信息接收的报文序列。**
	1）将当前报文的源MAC地址的最后一字节和当前报文的源IP的最后一字节异或，得到当前报文的序号
	2）将当前报文源IP最后一字节和目的地址的最后一字节异或得到一字节隐藏的信息
	3）将当前报文序号和报文信息加入到本次信息接收的序列
	**4）若该报文为本次信息接收序列的第一个报文，创建一个计时器**
3. **从序号为1的标志报文中提取真实源IP。** 判断本次信息接收序列的最后一个报文序号是否为1，若是1，说明是开始标志报文，其隐藏的信息为真实源IP主机号
4. **对当前报文序列按序号进行排序。** 为了便于后续判断本次信息接收是否结束和完整，对接收到的报文序列进行排序
5. **计时器对当前报文序列进行检查。** 计时器循环检查当前报文序列，并做出判断：
	1）若报文序列的第一个报文序号为1，且最后一个报文的内容与第一个报文内容一致，说明接收到开始和结束标志报文，本次信息接收完毕
	（1）  若结束标志报文的序号和报文序列的长度一致，显示接收成功，输出真实源IP和完整信息
	（2） 若结束标志报文的序号和报文序列的长度不一致，显示接收失败，输出真实源IP，和每个报文的序号以及对应的信息
	2）若从接收到上一个报文开始超过10s未接收到新的目的报文，说明本次信息接收超时，判定为接收失败，本次信息接收完毕。输出真实源IP（如果提取到）和每个报文序号及对应信息。
	3）信息接收完毕，关闭计时器

## 项目评价
### 优点
1. **隐蔽性强，并保证匿名性。** 信息隐藏方法新颖，而且无论成功与否，保证了发送者的匿名性（IP和MAC的伪造）
2. **端口号筛选报文。** 每次信息传输采用的端口号都不一样，一定程度增加了隐蔽性，并且将源端口和目的端口建立联系，增加了识别度
3. **序号机制。** 虽然采用UDP报文，但是实现了信息排序和完整性的识别，可以很好地解决由于网络不稳定导致的报文乱序到达和报文丢失的问题
4. **通信开始和结束标志。** 增加了开始和结束标志报文，便于接收方判断一次信息传输的开始与结束，并能从开始报文中提取出真实源IP
5. **计时器机制。** 计时机制保证了整体机制的可行性，避免了网络不稳定导致的无限等待问题，避免影响下一次的信息传输

### 缺点
1. 若发送者网络的主机号所占位数较少，可隐藏信息的位数较少，严重影响传输效率
2. 报文源IP地址相同的情况下，MAC地址不同，如果进行分析，可疑度较高
3. 如果网关或防火墙进行了IP地址与MAC地址的过滤，传输失败
4. 如果发送方网络经过NAT转换，该方法失效


该项目基于IP包的网络协议信息隐藏实现，其中隐藏信息的位数、端口号等只是项目环境下的特例，具体情况需要具体分析修改，且使用IP隐藏信息的方法新颖，隐蔽度较高，同时可扩展性将强，后期可以根据需要进一步完善其隐藏算法、失败重传机制等，应用场景较多，实用性较强。


		
	
